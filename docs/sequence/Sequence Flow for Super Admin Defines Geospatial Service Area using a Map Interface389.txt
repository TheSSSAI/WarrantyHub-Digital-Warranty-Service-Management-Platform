# 1 Overview

## 1.1 Diagram Id

SEQ-FF-002

## 1.2 Name

Super Admin Defines Geospatial Service Area using a Map Interface

## 1.3 Description

A Super Admin uses a map-based interface to draw a polygon and list postal codes, defining the geographic area where a specific service center is authorized to operate for a given brand.

## 1.4 Type

üîπ FeatureFlow

## 1.5 Purpose

To implement the core business logic of service request routing (REQ-FUNC-002) by creating the geospatial data needed to match a user's location to a service center.

## 1.6 Complexity

High

## 1.7 Priority

üî¥ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- web-client-012
- api-gateway-001
- service-center-service-004

## 1.10 Key Interactions

- Super Admin selects a service center/brand relationship in the admin portal.
- The UI displays an interactive map (using Mapbox GL JS).
- The admin uses drawing tools to create a polygon on the map.
- The client-side code converts the drawn shape into a GeoJSON object.
- The admin submits the GeoJSON polygon and a list of postal codes to the ServiceCenterService.
- The ServiceCenterService backend uses the NetTopologySuite library to parse the GeoJSON and convert it into a PostGIS `GEOMETRY` data type.
- The service saves the `GEOMETRY` object and postal codes to the database, associating them with the service center and brand.

## 1.11 Triggers

- A Super Admin needs to configure or update a service center's operational boundaries.

## 1.12 Outcomes

- A geospatial record is created in the database representing the service area.
- The service request routing engine can now use this data to assign tickets.

## 1.13 Business Rules

- A service area is defined as a combination of a polygon and a list of postal codes.
- A service center can have different service areas for different brands they service.

## 1.14 Error Scenarios

- The submitted GeoJSON is invalid or represents a self-intersecting polygon.
- The database is unable to save the geospatial data.
- The PostGIS extension is not enabled or configured correctly.

## 1.15 Integration Points

- Mapbox GL JS
- NetTopologySuite
- PostgreSQL with PostGIS

# 2.0 Details

## 2.1 Diagram Id

SEQ-FF-002

## 2.2 Name

Super Admin Defines Service Center Geospatial Service Area

## 2.3 Description

Implementation-ready sequence diagram detailing the technical flow for a Super Admin to define a service center's operational area using a map interface. This involves client-side GeoJSON generation, API submission, and backend geospatial data processing and persistence using PostGIS.

## 2.4 Participants

### 2.4.1 Web Client (SPA)

#### 2.4.1.1 Repository Id

web-client-012

#### 2.4.1.2 Display Name

Admin Web Client

#### 2.4.1.3 Type

üîπ Web Client (SPA)

#### 2.4.1.4 Technology

React 18, TypeScript, Mapbox GL JS

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #4287f5 |
| Stereotype | Client |

### 2.4.2.0 Gateway

#### 2.4.2.1 Repository Id

api-gateway-001

#### 2.4.2.2 Display Name

API Gateway

#### 2.4.2.3 Type

üîπ Gateway

#### 2.4.2.4 Technology

YARP on .NET 8

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #f5a623 |
| Stereotype | Gateway |

### 2.4.3.0 Service

#### 2.4.3.1 Repository Id

service-center-service-004

#### 2.4.3.2 Display Name

Service Center Service

#### 2.4.3.3 Type

üîπ Service

#### 2.4.3.4 Technology

.NET 8, ASP.NET Core, NetTopologySuite

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #7ed321 |
| Stereotype | Microservice |

## 2.5.0.0 Interactions

### 2.5.1.0 User Interaction

#### 2.5.1.1 Source Id

web-client-012

#### 2.5.1.2 Target Id

web-client-012

#### 2.5.1.3 Message

Super Admin draws a polygon using Mapbox tools and enters a list of postal codes. Client-side logic converts the shape to a valid GeoJSON object.

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ User Interaction

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚ùå No

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | N/A |
| Method | MapboxGL.Draw().getAll() |
| Parameters | User mouse events |
| Authentication | N/A |
| Error Handling | UI validation to ensure polygon is drawn and posta... |
| Performance | Client-side rendering performance is dependent on ... |

#### 2.5.1.11 Nested Interactions

*No items available*

### 2.5.2.0 API Request

#### 2.5.2.1 Source Id

web-client-012

#### 2.5.2.2 Target Id

api-gateway-001

#### 2.5.2.3 Message

Submits service area definition for a specific ServiceCenter-Brand relationship.

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ API Request

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

Returns 204 No Content on success or an error object on failure.

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚úÖ Yes

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS/1.1 |
| Method | PUT /api/v1/service-areas/{serviceAreaId} |
| Parameters | URL Param: serviceAreaId (GUID). Body: UpdateServi... |
| Authentication | Requires valid JWT. Header: 'Authorization: Bearer... |
| Error Handling | Client handles 400, 403, 404, 5xx responses and di... |
| Performance | Request size is typically small (<50KB). |

#### 2.5.2.11 Nested Interactions

*No items available*

### 2.5.3.0 Request Routing

#### 2.5.3.1 Source Id

api-gateway-001

#### 2.5.3.2 Target Id

service-center-service-004

#### 2.5.3.3 Message

Validates JWT and routes the request to the Service Center Service.

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Request Routing

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

Forwards the response from the upstream service.

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTP |
| Method | PUT /service-areas/{serviceAreaId} |
| Parameters | Forwards original request body and headers. |
| Authentication | JWT validation is the primary responsibility. Reje... |
| Error Handling | Returns 503 if the upstream service is unavailable... |
| Performance | Adds <10ms latency. |

#### 2.5.3.11 Nested Interactions

*No items available*

### 2.5.4.0 Security Checkpoint

#### 2.5.4.1 Source Id

service-center-service-004

#### 2.5.4.2 Target Id

service-center-service-004

#### 2.5.4.3 Message

Authorize request based on user claims.

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Security Checkpoint

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

Throws AuthorizationException on failure.

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚ùå No

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | [Authorization(Roles = "SuperAdmin")] |
| Parameters | User principal from JWT claims. |
| Authentication | Verifies that the 'role' claim contains 'SuperAdmi... |
| Error Handling | ASP.NET Core middleware catches AuthorizationExcep... |
| Performance | Negligible overhead. |

#### 2.5.4.11 Nested Interactions

*No items available*

### 2.5.5.0 Data Transformation

#### 2.5.5.1 Source Id

service-center-service-004

#### 2.5.5.2 Target Id

service-center-service-004

#### 2.5.5.3 Message

Validate DTO, parse GeoJSON string into a Geometry object, and prepare for persistence.

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Data Transformation

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message

Returns a domain entity or throws ValidationException.

#### 2.5.5.8 Has Return

‚úÖ Yes

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | var geometry = new GeoJsonReader().Read<Polygon>(d... |
| Parameters | Input DTO. |
| Authentication | N/A |
| Error Handling | Catches exceptions from NetTopologySuite (e.g., fo... |
| Performance | Parsing is CPU-bound but fast for typical polygon ... |

#### 2.5.5.11 Nested Interactions

*No items available*

### 2.5.6.0 Database Operation

#### 2.5.6.1 Source Id

service-center-service-004

#### 2.5.6.2 Target Id

service-center-service-004

#### 2.5.6.3 Message

Persist the Geometry object and postal codes to the database.

#### 2.5.6.4 Sequence Number

6

#### 2.5.6.5 Type

üîπ Database Operation

#### 2.5.6.6 Is Synchronous

‚úÖ Yes

#### 2.5.6.7 Return Message

Returns success or throws DbUpdateException.

#### 2.5.6.8 Has Return

‚úÖ Yes

#### 2.5.6.9 Is Activation

‚ùå No

#### 2.5.6.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | TCP/IP (Npgsql) |
| Method | dbContext.SaveChangesAsync() |
| Parameters | The updated ServiceArea entity. The Npgsql EF Core... |
| Authentication | Uses connection string credentials from Azure Key ... |
| Error Handling | Catches DbUpdateException for database-level error... |
| Performance | Dependent on database performance. Relies on the P... |

#### 2.5.6.11 Nested Interactions

*No items available*

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

The database table must have a column of type `GEOMETRY(Polygon, 4326)` to store the data. A spatial index (GiST) must be created on this column to ensure future point-in-polygon queries for service request routing are performant.

#### 2.6.1.2 Position

bottom

#### 2.6.1.3 Participant Id

service-center-service-004

#### 2.6.1.4 Sequence Number

6

### 2.6.2.0 Content

#### 2.6.2.1 Content

REQ-FUNC-002: This entire sequence implements the data creation part of the geospatial service area definition requirement.

#### 2.6.2.2 Position

top

#### 2.6.2.3 Participant Id

*Not specified*

#### 2.6.2.4 Sequence Number

0

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | Role-based access control (RBAC) must be strictly ... |
| Performance Targets | The API endpoint `PUT /api/v1/service-areas/{servi... |
| Error Handling Strategy | The `ServiceCenterService` must provide clear erro... |
| Testing Considerations | Unit tests must cover the GeoJSON validation and p... |
| Monitoring Requirements | Monitor the latency and error rate (4xx/5xx) of th... |
| Deployment Considerations | This feature requires a database migration managed... |

