# 1 Overview

## 1.1 Diagram Id

SEQ-DF-001

## 1.2 Name

Brand Admin Views Product Analytics Dashboard from Read Replica

## 1.3 Description

A Brand Administrator logs in and views their dashboard. The system queries a dedicated database read replica to generate analytics widgets without impacting the performance of the primary transactional database.

## 1.4 Type

ðŸ”¹ DataFlow

## 1.5 Purpose

To provide brands with valuable insights into their products' performance, service trends, and geographic distribution (REQ-FUNC-011), while maintaining high performance for the core application.

## 1.6 Complexity

Medium

## 1.7 Priority

ðŸ”´ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- web-client-012
- api-gateway-001
- reporting-service-008

## 1.10 Key Interactions

- Brand Admin navigates to the dashboard page in the web portal.
- The client makes multiple, parallel API calls to the ReportingService for each widget's data (e.g., registrations per month, faults by type).
- API Gateway routes these requests to the ReportingService.
- The ReportingService, configured with a connection string to the PostgreSQL read replica, executes several pre-defined aggregation queries.
- The read replica processes the queries, and the ReportingService returns the aggregated data in JSON format.
- The client renders the data using charting libraries (e.g., Recharts).

## 1.11 Triggers

- Brand Admin accesses their main dashboard.

## 1.12 Outcomes

- The Brand Admin's dashboard is populated with up-to-date charts and metrics.
- The admin can export the reports in CSV or PDF format.

## 1.13 Business Rules

- A Brand Admin can only see data related to their own brand (enforced by RBAC and database queries).
- Data for analytics must be read from a non-primary source to offload read-heavy queries.

## 1.14 Error Scenarios

- The reporting service is unavailable.
- A database query for an aggregation times out.
- Replication lag on the read replica results in slightly stale data.

## 1.15 Integration Points

- PostgreSQL Read Replica

# 2.0 Details

## 2.1 Diagram Id

SEQ-DF-001

## 2.2 Name

Brand Admin Views Product Analytics Dashboard from Read Replica

## 2.3 Description

This sequence details the data flow for a Brand Administrator viewing their product analytics dashboard. It implements the Command Query Responsibility Segregation (CQRS) pattern by directing all read-heavy, analytical queries to a dedicated PostgreSQL read replica. This protects the performance of the primary transactional database, ensuring core application responsiveness. The Reporting Service is specifically configured to connect to this replica and enforces strict data tenancy using the 'brandId' claim from the Brand Admin's JWT.

## 2.4 Participants

### 2.4.1 Client

#### 2.4.1.1 Repository Id

web-client-012

#### 2.4.1.2 Display Name

Admin Web Client

#### 2.4.1.3 Type

ðŸ”¹ Client

#### 2.4.1.4 Technology

React 18, TypeScript, Recharts

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #F5A623 |
| Stereotype | User Interface |

### 2.4.2.0 Gateway

#### 2.4.2.1 Repository Id

api-gateway-001

#### 2.4.2.2 Display Name

API Gateway

#### 2.4.2.3 Type

ðŸ”¹ Gateway

#### 2.4.2.4 Technology

Azure API Management

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | boundary |
| Color | #4A90E2 |
| Stereotype | API Facade |

### 2.4.3.0 Service

#### 2.4.3.1 Repository Id

reporting-service-008

#### 2.4.3.2 Display Name

Reporting Service

#### 2.4.3.3 Type

ðŸ”¹ Service

#### 2.4.3.4 Technology

.NET 8, ASP.NET Core, EF Core

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | control |
| Color | #7ED321 |
| Stereotype | Microservice |

## 2.5.0.0 Interactions

- {'sourceId': 'web-client-012', 'targetId': 'api-gateway-001', 'message': '1. GET /api/reports/registrations-by-month', 'sequenceNumber': 1, 'type': 'Request', 'isSynchronous': True, 'returnMessage': '9. [200 OK] { data: [...] }', 'hasReturn': True, 'isActivation': True, 'technicalDetails': {'protocol': 'HTTPS/1.1', 'method': 'GET', 'parameters': 'No explicit parameters. Brand context is derived from JWT.', 'authentication': 'Authorization: Bearer <JWT>', 'errorHandling': 'Client handles 401, 403, 500, 503 responses by displaying an error message in the corresponding widget.', 'performance': 'P95 latency target < 250ms (end-to-end).'}, 'nestedInteractions': [{'sourceId': 'api-gateway-001', 'targetId': 'reporting-service-008', 'message': '2. GET /registrations-by-month', 'sequenceNumber': 2, 'type': 'ForwardRequest', 'isSynchronous': True, 'returnMessage': '8. [200 OK] { data: [...] }', 'hasReturn': True, 'isActivation': True, 'technicalDetails': {'protocol': 'HTTP', 'method': 'GET', 'parameters': 'JWT claims are forwarded.', 'authentication': "Validates JWT signature, issuer, and audience. Checks for 'BrandAdmin' role.", 'errorHandling': 'Returns 401/403 on auth failure. Returns 5xx if upstream service is unavailable.', 'performance': 'Gateway latency overhead < 20ms.'}, 'nestedInteractions': [{'sourceId': 'reporting-service-008', 'targetId': 'reporting-service-008', 'message': "3. Extract 'brandId' claim from JWT principal", 'sequenceNumber': 3, 'type': 'InternalProcessing', 'isSynchronous': True, 'returnMessage': '', 'hasReturn': False, 'isActivation': False, 'technicalDetails': {'protocol': 'In-Process', 'method': "IHttpContextAccessor.HttpContext.User.FindFirst('brand_id')", 'parameters': 'User principal from JWT', 'authentication': "Authorization policy check: [Authorize(Roles = 'BrandAdmin')]", 'errorHandling': 'If claim is missing or invalid, throws SecurityException resulting in a 403 Forbidden response.', 'performance': 'Negligible (<1ms).'}, 'nestedInteractions': []}, {'sourceId': 'reporting-service-008', 'targetId': 'reporting-service-008', 'message': '4. Execute aggregation query on Read Replica', 'sequenceNumber': 4, 'type': 'DatabaseQuery', 'isSynchronous': True, 'returnMessage': '5. Aggregated result set', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'TCP/IP (Npgsql)', 'method': 'EF Core LINQ Query (e.g., dbContext.UserProducts.Where(p => p.BrandId == brandId)...)', 'parameters': "SQL query with 'brandId' as a parameterized value.", 'authentication': 'Connects using connection string from Key Vault with credentials for read replica.', 'errorHandling': 'Polly retry policy for transient NpgsqlExceptions. Catches query timeouts, returning 503 Service Unavailable.', 'performance': 'Query execution target < 100ms. Requires indexes on BrandId and date columns.'}, 'nestedInteractions': []}, {'sourceId': 'reporting-service-008', 'targetId': 'reporting-service-008', 'message': '6. Map result set to DTO', 'sequenceNumber': 6, 'type': 'DataTransformation', 'isSynchronous': True, 'returnMessage': '7. DTO object', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'In-Process', 'method': 'AutoMapper Profile or manual mapping', 'parameters': 'Database query result', 'authentication': 'N/A', 'errorHandling': 'N/A', 'performance': 'Negligible.'}, 'nestedInteractions': []}]}]}

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

Parallel API Requests: The web client initiates multiple, parallel API calls (e.g., for registrations, fault patterns, geographic distribution) to populate all dashboard widgets simultaneously using Promise.all(). This diagram shows the flow for a single widget for clarity.

#### 2.6.1.2 Position

top

#### 2.6.1.3 Participant Id

*Not specified*

#### 2.6.1.4 Sequence Number

1

### 2.6.2.0 Content

#### 2.6.2.1 Content

Read Replica: All database queries within this service are executed against a PostgreSQL Read Replica. This is configured via the service's connection string and is transparent to the application logic (Repository Pattern).

#### 2.6.2.2 Position

right

#### 2.6.2.3 Participant Id

reporting-service-008

#### 2.6.2.4 Sequence Number

4

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | 1. JWT Validation: The API Gateway must perform st... |
| Performance Targets | 1. API Latency: The end-to-end P95 latency for all... |
| Error Handling Strategy | 1. Client-Side: The React client should handle API... |
| Testing Considerations | 1. Integration Testing: The Reporting Service's in... |
| Monitoring Requirements | 1. API Metrics: Monitor the latency, traffic, and ... |
| Deployment Considerations | The Reporting Service's deployment configuration (... |

