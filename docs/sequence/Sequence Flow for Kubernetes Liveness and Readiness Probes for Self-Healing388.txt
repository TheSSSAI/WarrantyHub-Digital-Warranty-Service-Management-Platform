# 1 Overview

## 1.1 Diagram Id

SEQ-OP-002

## 1.2 Name

Kubernetes Liveness and Readiness Probes for Self-Healing

## 1.3 Description

The Kubernetes orchestrator periodically checks the health of running microservice instances. It uses a readiness probe to control traffic flow during startup and a liveness probe to restart unhealthy containers.

## 1.4 Type

üîπ OperationalFlow

## 1.5 Purpose

To enable automated self-healing and ensure traffic is only sent to healthy, fully-initialized application instances, contributing to the system's overall reliability and availability.

## 1.6 Complexity

Low

## 1.7 Priority

üî¥ High

## 1.8 Frequency

Every15Seconds

## 1.9 Participants

- product-service-003

## 1.10 Key Interactions

- Readiness Probe: On pod startup, Kubelet sends an HTTP GET request to the pod's `/health/ready` endpoint. The service checks its dependencies (e.g., database connection). It returns 200 OK only when ready. The pod is not added to the service's load balancer until this probe succeeds.
- Liveness Probe: After startup, Kubelet sends an HTTP GET to `/health/live`. The service performs a quick internal check (e.g., not deadlocked). If it fails multiple consecutive times, Kubelet terminates the container, and the ReplicaSet starts a new one.

## 1.11 Triggers

- Periodic checks configured in the Kubernetes Deployment manifest.

## 1.12 Outcomes

- Traffic is prevented from being routed to a pod that is starting up or has lost a critical dependency.
- A pod that is stuck in an unrecoverable state is automatically restarted.

## 1.13 Business Rules

- Each microservice must expose `/health/live` and `/health/ready` endpoints via ASP.NET Core Health Checks.

## 1.14 Error Scenarios

- A flapping service is continuously restarted by its liveness probe.
- A misconfigured readiness probe prevents a healthy pod from ever receiving traffic.
- A transient dependency failure causes all pods to become unready simultaneously, leading to a brief outage.

## 1.15 Integration Points

- Azure Kubernetes Service (Kubelet)
- ASP.NET Core Health Checks

# 2.0 Details

## 2.1 Diagram Id

SEQ-OP-002

## 2.2 Name

Implementation: Kubernetes Liveness and Readiness Probe Health Checks

## 2.3 Description

Technical sequence detailing how the Kubernetes Kubelet on an AKS node interacts with a microservice's ASP.NET Core Health Check endpoints to perform automated self-healing and manage traffic routing. This sequence covers both the readiness probe (for determining if a pod is ready to accept traffic) and the liveness probe (for determining if a running pod is healthy).

## 2.4 Participants

### 2.4.1 Orchestrator

#### 2.4.1.1 Repository Id

Kubernetes.Kubelet

#### 2.4.1.2 Display Name

Kubelet (AKS Node Agent)

#### 2.4.1.3 Type

üîπ Orchestrator

#### 2.4.1.4 Technology

Kubernetes v1.29

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #326CE5 |
| Stereotype | System |

### 2.4.2.0 Service

#### 2.4.2.1 Repository Id

product-service-003

#### 2.4.2.2 Display Name

ProductService Pod

#### 2.4.2.3 Type

üîπ Service

#### 2.4.2.4 Technology

.NET 8, ASP.NET Core 8

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #00AB5A |
| Stereotype | Microservice |

### 2.4.3.0 Orchestrator

#### 2.4.3.1 Repository Id

Kubernetes.APIServer

#### 2.4.3.2 Display Name

Kubernetes API Server

#### 2.4.3.3 Type

üîπ Orchestrator

#### 2.4.3.4 Technology

Kubernetes v1.29

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #326CE5 |
| Stereotype | System Control Plane |

### 2.4.4.0 Orchestrator

#### 2.4.4.1 Repository Id

Kubernetes.EndpointController

#### 2.4.4.2 Display Name

Kubernetes Endpoint Controller

#### 2.4.4.3 Type

üîπ Orchestrator

#### 2.4.4.4 Technology

Kubernetes v1.29

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #326CE5 |
| Stereotype | System Control Plane |

## 2.5.0.0 Interactions

### 2.5.1.0 Request

#### 2.5.1.1 Source Id

Kubernetes.Kubelet

#### 2.5.1.2 Target Id

product-service-003

#### 2.5.1.3 Message

1. [Readiness Probe] Sends probe to determine service readiness after initial startup delay.

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Request

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message

Returns HTTP 200 OK or HTTP 503 Service Unavailable.

#### 2.5.1.8 Has Return

‚úÖ Yes

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTP/1.1 |
| Method | GET /health/ready |
| Parameters | Configured in Deployment manifest: initialDelaySec... |
| Authentication | None. Intra-cluster communication is considered tr... |
| Error Handling | Kubelet will retry the probe according to 'periodS... |
| Performance | Endpoint must respond within 'timeoutSeconds' (typ... |

#### 2.5.1.11 Nested Interactions

- {'sourceId': 'product-service-003', 'targetId': 'product-service-003', 'message': '1a. Executes ASP.NET Core Health Checks. Verifies critical dependencies (e.g., database connectivity, cache availability).', 'sequenceNumber': 2, 'type': 'Internal Processing', 'isSynchronous': True, 'returnMessage': 'Aggregates health status of dependencies.', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'Internal', 'method': 'IHealthCheck.CheckHealthAsync()', 'parameters': 'CancellationToken', 'authentication': 'N/A', 'errorHandling': "Individual dependency checks can time out. Aggregate status is 'Unhealthy' if any critical check fails.", 'performance': "Checks must be fast to not exceed Kubelet's probe timeout. Use caching for dependency checks if appropriate."}}

### 2.5.2.0 Response

#### 2.5.2.1 Source Id

product-service-003

#### 2.5.2.2 Target Id

Kubernetes.Kubelet

#### 2.5.2.3 Message

2. [ALT: Success Path] Returns HTTP 200 OK, indicating all dependencies are healthy.

#### 2.5.2.4 Sequence Number

3

#### 2.5.2.5 Type

üîπ Response

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message



#### 2.5.2.8 Has Return

‚ùå No

#### 2.5.2.9 Is Activation

‚ùå No

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTP/1.1 |
| Method | 200 OK |
| Parameters | Body contains JSON health report. |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

### 2.5.3.0 Request

#### 2.5.3.1 Source Id

Kubernetes.Kubelet

#### 2.5.3.2 Target Id

Kubernetes.APIServer

#### 2.5.3.3 Message

3. Reports successful probe to API Server, updating Pod's condition to 'Ready'.

#### 2.5.3.4 Sequence Number

4

#### 2.5.3.5 Type

üîπ Request

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

API Server acknowledges status update.

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS (gRPC) |
| Method | PATCH /api/v1/pods/{pod-name}/status |
| Parameters | Payload: { 'status': { 'conditions': [{ 'type': 'R... |
| Authentication | Kubelet uses client certificate for authentication... |
| Error Handling | Retry on transient connection failures to the API ... |
| Performance | Low latency is expected for control plane communic... |

### 2.5.4.0 Event Notification

#### 2.5.4.1 Source Id

Kubernetes.APIServer

#### 2.5.4.2 Target Id

Kubernetes.EndpointController

#### 2.5.4.3 Message

4. Watches Pod status change and adds the Pod's IP address to the Service's Endpoints object.

#### 2.5.4.4 Sequence Number

5

#### 2.5.4.5 Type

üîπ Event Notification

#### 2.5.4.6 Is Synchronous

‚ùå No

#### 2.5.4.7 Return Message



#### 2.5.4.8 Has Return

‚ùå No

#### 2.5.4.9 Is Activation

‚úÖ Yes

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Kubernetes Watch API |
| Method | Watch Event (MODIFIED) |
| Parameters | Pod object data |
| Authentication | Internal control plane security. |
| Error Handling | The controller will reconcile state until the endp... |
| Performance | Near real-time. |

### 2.5.5.0 Response

#### 2.5.5.1 Source Id

product-service-003

#### 2.5.5.2 Target Id

Kubernetes.Kubelet

#### 2.5.5.3 Message

2. [ALT: Failure Path] Returns HTTP 503 Service Unavailable, indicating a dependency is unhealthy.

#### 2.5.5.4 Sequence Number

6

#### 2.5.5.5 Type

üîπ Response

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message



#### 2.5.5.8 Has Return

‚ùå No

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTP/1.1 |
| Method | 503 Service Unavailable |
| Parameters | Body contains JSON health report detailing the fai... |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

### 2.5.6.0 Request

#### 2.5.6.1 Source Id

Kubernetes.Kubelet

#### 2.5.6.2 Target Id

Kubernetes.APIServer

#### 2.5.6.3 Message

3a. Reports failed probe. Pod remains in/enters 'Not Ready' state and is not added to service endpoints.

#### 2.5.6.4 Sequence Number

7

#### 2.5.6.5 Type

üîπ Request

#### 2.5.6.6 Is Synchronous

‚úÖ Yes

#### 2.5.6.7 Return Message

API Server acknowledges status update.

#### 2.5.6.8 Has Return

‚úÖ Yes

#### 2.5.6.9 Is Activation

‚ùå No

#### 2.5.6.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS (gRPC) |
| Method | PATCH /api/v1/pods/{pod-name}/status |
| Parameters | Payload: { 'status': { 'conditions': [{ 'type': 'R... |
| Authentication | Kubelet uses client certificate for authentication... |
| Error Handling | Retry on transient connection failures to the API ... |
| Performance | Low latency is expected for control plane communic... |

### 2.5.7.0 Request

#### 2.5.7.1 Source Id

Kubernetes.Kubelet

#### 2.5.7.2 Target Id

product-service-003

#### 2.5.7.3 Message

5. [Liveness Probe] Periodically sends probe to check if the running application is still healthy.

#### 2.5.7.4 Sequence Number

8

#### 2.5.7.5 Type

üîπ Request

#### 2.5.7.6 Is Synchronous

‚úÖ Yes

#### 2.5.7.7 Return Message

Returns HTTP 200 OK on success, or fails on timeout/non-200 response.

#### 2.5.7.8 Has Return

‚úÖ Yes

#### 2.5.7.9 Is Activation

‚ùå No

#### 2.5.7.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTP/1.1 |
| Method | GET /health/live |
| Parameters | Configured in Deployment manifest: periodSeconds, ... |
| Authentication | None. |
| Error Handling | Kubelet increments a failure counter. If it exceed... |
| Performance | Endpoint must be extremely lightweight and fast (<... |

#### 2.5.7.11 Nested Interactions

- {'sourceId': 'product-service-003', 'targetId': 'product-service-003', 'message': '5a. Executes a lightweight self-check (e.g., checks for thread pool starvation, internal state consistency).', 'sequenceNumber': 9, 'type': 'Internal Processing', 'isSynchronous': True, 'returnMessage': 'Returns healthy or unhealthy status.', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'Internal', 'method': 'IHealthCheck.CheckHealthAsync()', 'parameters': 'CancellationToken', 'authentication': 'N/A', 'errorHandling': 'This check MUST NOT have external dependencies to prevent cascading failures.', 'performance': 'Critical to be very low latency.'}}

### 2.5.8.0 Response

#### 2.5.8.1 Source Id

product-service-003

#### 2.5.8.2 Target Id

Kubernetes.Kubelet

#### 2.5.8.3 Message

6. [ALT: Success Path] Returns HTTP 200 OK. No action is taken.

#### 2.5.8.4 Sequence Number

10

#### 2.5.8.5 Type

üîπ Response

#### 2.5.8.6 Is Synchronous

‚úÖ Yes

#### 2.5.8.7 Return Message



#### 2.5.8.8 Has Return

‚ùå No

#### 2.5.8.9 Is Activation

‚ùå No

#### 2.5.8.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTP/1.1 |
| Method | 200 OK |
| Parameters | Body contains minimal JSON health report. |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

### 2.5.9.0 Error Response

#### 2.5.9.1 Source Id

product-service-003

#### 2.5.9.2 Target Id

Kubernetes.Kubelet

#### 2.5.9.3 Message

6. [ALT: Failure Path] Fails to respond or returns non-200 code.

#### 2.5.9.4 Sequence Number

11

#### 2.5.9.5 Type

üîπ Error Response

#### 2.5.9.6 Is Synchronous

‚úÖ Yes

#### 2.5.9.7 Return Message



#### 2.5.9.8 Has Return

‚ùå No

#### 2.5.9.9 Is Activation

‚ùå No

#### 2.5.9.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTP/1.1 |
| Method | 503 Service Unavailable or Timeout |
| Parameters | N/A |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

### 2.5.10.0 Internal Processing

#### 2.5.10.1 Source Id

Kubernetes.Kubelet

#### 2.5.10.2 Target Id

Kubernetes.Kubelet

#### 2.5.10.3 Message

7. Increments internal failure counter. If counter exceeds 'failureThreshold' (e.g., 3), initiates container restart.

#### 2.5.10.4 Sequence Number

12

#### 2.5.10.5 Type

üîπ Internal Processing

#### 2.5.10.6 Is Synchronous

‚úÖ Yes

#### 2.5.10.7 Return Message

Decision to restart container.

#### 2.5.10.8 Has Return

‚úÖ Yes

#### 2.5.10.9 Is Activation

‚ùå No

#### 2.5.10.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal Logic |
| Method | EvaluateProbeResult |
| Parameters | Probe Status, Failure Counter, Failure Threshold |
| Authentication | N/A |
| Error Handling | The restart action is a core part of the self-heal... |
| Performance | N/A |

### 2.5.11.0 Request

#### 2.5.11.1 Source Id

Kubernetes.Kubelet

#### 2.5.11.2 Target Id

Kubernetes.APIServer

#### 2.5.11.3 Message

8. Posts a Kubernetes Event indicating Liveness probe failed and container will be restarted.

#### 2.5.11.4 Sequence Number

13

#### 2.5.11.5 Type

üîπ Request

#### 2.5.11.6 Is Synchronous

‚ùå No

#### 2.5.11.7 Return Message



#### 2.5.11.8 Has Return

‚ùå No

#### 2.5.11.9 Is Activation

‚ùå No

#### 2.5.11.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS (gRPC) |
| Method | POST /api/v1/events |
| Parameters | Event object detailing the failure. |
| Authentication | Client certificate. |
| Error Handling | Fire-and-forget. The primary action is the restart... |
| Performance | N/A |

### 2.5.12.0 Signal

#### 2.5.12.1 Source Id

Kubernetes.Kubelet

#### 2.5.12.2 Target Id

product-service-003

#### 2.5.12.3 Message

9. Sends SIGTERM to the container, initiating a graceful shutdown.

#### 2.5.12.4 Sequence Number

14

#### 2.5.12.5 Type

üîπ Signal

#### 2.5.12.6 Is Synchronous

‚ùå No

#### 2.5.12.7 Return Message



#### 2.5.12.8 Has Return

‚ùå No

#### 2.5.12.9 Is Activation

‚ùå No

#### 2.5.12.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | OS Signal |
| Method | SIGTERM |
| Parameters | Process ID (PID 1) of the container. |
| Authentication | N/A |
| Error Handling | If process does not terminate within 'terminationG... |
| Performance | N/A |

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

All probe behavior (initialDelaySeconds, periodSeconds, timeoutSeconds, successThreshold, failureThreshold) is configured declaratively in the Kubernetes Deployment manifest, managed via GitOps.

#### 2.6.1.2 Position

Top

#### 2.6.1.3 Participant Id

*Not specified*

#### 2.6.1.4 Sequence Number

0

### 2.6.2.0 Content

#### 2.6.2.1 Content

Readiness Probe: MUST check external dependencies. Its failure should not cause a restart, only traffic removal.

#### 2.6.2.2 Position

Middle

#### 2.6.2.3 Participant Id

product-service-003

#### 2.6.2.4 Sequence Number

2

### 2.6.3.0 Content

#### 2.6.3.1 Content

Liveness Probe: MUST NOT check external dependencies. It should be a lightweight, fast check to confirm the process itself is not deadlocked or corrupted.

#### 2.6.3.2 Position

Bottom

#### 2.6.3.3 Participant Id

product-service-003

#### 2.6.3.4 Sequence Number

9

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | Health check endpoints should not expose any sensi... |
| Performance Targets | Liveness probe endpoint P99 latency must be < 100m... |
| Error Handling Strategy | A 'flapping' service (failing liveness probes freq... |
| Testing Considerations | Unit test individual health checks. In a Staging e... |
| Monitoring Requirements | Configure Azure Monitor Alerts for any Pod with a ... |
| Deployment Considerations | Properly configure 'initialDelaySeconds' to give t... |

