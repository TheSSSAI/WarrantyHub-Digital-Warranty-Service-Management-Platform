# 1 Overview

## 1.1 Diagram Id

SEQ-CF-002

## 1.2 Name

User Data Deletion Request (GDPR Right to be Forgotten)

## 1.3 Description

A user initiates a request to delete their personal data. The system orchestrates the anonymization or deletion of their PII across multiple microservices while maintaining the integrity of non-personal analytical data.

## 1.4 Type

ðŸ”¹ ComplianceFlow

## 1.5 Purpose

To fulfill legal and regulatory requirements for data privacy and user rights.

## 1.6 Complexity

Critical

## 1.7 Priority

ðŸ”´ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- mobile-client-013
- api-gateway-001
- identity-service-002
- product-service-003
- service-request-service-005

## 1.10 Key Interactions

- User submits a 'Delete My Account' request.
- The request is routed to the IdentityService.
- IdentityService initiates a data deletion saga/workflow.
- It first soft-deletes the user's primary account, revoking all tokens.
- It then publishes a 'UserDataDeletionRequested' event containing the userId.
- Downstream services (ProductService, ServiceRequestService) consume this event.
- Each service is responsible for anonymizing PII in the records it owns (e.g., replacing user's name and address in service requests with '[DELETED USER]').
- After all services confirm completion, the IdentityService can hard-delete the main user record.

## 1.11 Triggers

- User requests the deletion of their personal data.

## 1.12 Outcomes

- The user's account is deactivated and their PII is permanently removed or anonymized across the system.
- Transactional records are preserved for analytics but are disassociated from the user's identity.

## 1.13 Business Rules

- The system must provide a mechanism for users to request the deletion of their personal data.
- PII must be anonymized, but non-personal data (e.g., product model, issue type) from service requests should be retained for analytics.

## 1.14 Error Scenarios

- One of the downstream services fails to process the deletion event, leaving orphaned PII.
- The saga fails and must be compensated or manually retried.

## 1.15 Integration Points

- Azure Service Bus

# 2.0 Details

## 2.1 Diagram Id

SEQ-CF-002-IMPL

## 2.2 Name

Implementation: GDPR User Data Deletion Request Saga

## 2.3 Description

A detailed technical sequence for orchestrating the anonymization and deletion of a user's Personal Identifiable Information (PII) across multiple microservices to comply with GDPR 'Right to be Forgotten' requirements. The sequence uses an event-driven saga pattern for resilience and decoupling.

## 2.4 Participants

### 2.4.1 Client Application

#### 2.4.1.1 Repository Id

mobile-client-013

#### 2.4.1.2 Display Name

Mobile Client

#### 2.4.1.3 Type

ðŸ”¹ Client Application

#### 2.4.1.4 Technology

Flutter 3.19+

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #E0E0E0 |
| Stereotype | User Interface |

### 2.4.2.0 Gateway

#### 2.4.2.1 Repository Id

api-gateway-001

#### 2.4.2.2 Display Name

API Gateway

#### 2.4.2.3 Type

ðŸ”¹ Gateway

#### 2.4.2.4 Technology

YARP on .NET 8

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #B3E5FC |
| Stereotype | API Facade |

### 2.4.3.0 Microservice

#### 2.4.3.1 Repository Id

identity-service-002

#### 2.4.3.2 Display Name

Identity Service

#### 2.4.3.3 Type

ðŸ”¹ Microservice

#### 2.4.3.4 Technology

.NET 8, ASP.NET Core 8

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #C8E6C9 |
| Stereotype | Saga Orchestrator |

### 2.4.4.0 Message Broker

#### 2.4.4.1 Repository Id

messaging-infra-015

#### 2.4.4.2 Display Name

Azure Service Bus

#### 2.4.4.3 Type

ðŸ”¹ Message Broker

#### 2.4.4.4 Technology

Azure PaaS

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #FFECB3 |
| Stereotype | Event Bus |

### 2.4.5.0 Microservice

#### 2.4.5.1 Repository Id

product-service-003

#### 2.4.5.2 Display Name

Product Service

#### 2.4.5.3 Type

ðŸ”¹ Microservice

#### 2.4.5.4 Technology

.NET 8, ASP.NET Core 8

#### 2.4.5.5 Order

5

#### 2.4.5.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #D1C4E9 |
| Stereotype | Saga Participant |

### 2.4.6.0 Microservice

#### 2.4.6.1 Repository Id

service-request-service-005

#### 2.4.6.2 Display Name

Service Request Service

#### 2.4.6.3 Type

ðŸ”¹ Microservice

#### 2.4.6.4 Technology

.NET 8, ASP.NET Core 8

#### 2.4.6.5 Order

6

#### 2.4.6.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #D1C4E9 |
| Stereotype | Saga Participant |

### 2.4.7.0 Microservice

#### 2.4.7.1 Repository Id

audit-service-009

#### 2.4.7.2 Display Name

Audit Service

#### 2.4.7.3 Type

ðŸ”¹ Microservice

#### 2.4.7.4 Technology

.NET 8 Worker Service

#### 2.4.7.5 Order

7

#### 2.4.7.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #F5F5F5 |
| Stereotype | Compliance Log |

## 2.5.0.0 Interactions

### 2.5.1.0 Request

#### 2.5.1.1 Source Id

mobile-client-013

#### 2.5.1.2 Target Id

api-gateway-001

#### 2.5.1.3 Message

1. DELETE /api/v1/users/me

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

ðŸ”¹ Request

#### 2.5.1.6 Is Synchronous

âœ… Yes

#### 2.5.1.7 Return Message

8. HTTP 202 Accepted

#### 2.5.1.8 Has Return

âœ… Yes

#### 2.5.1.9 Is Activation

âœ… Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | DELETE |
| Parameters | Headers: Authorization: Bearer <JWT> |
| Authentication | JWT Bearer Token required. |
| Error Handling | Client handles 401 (Unauthorized), 403 (Forbidden)... |
| Performance | P95 Latency < 250ms |

### 2.5.2.0 Request

#### 2.5.2.1 Source Id

api-gateway-001

#### 2.5.2.2 Target Id

identity-service-002

#### 2.5.2.3 Message

2. DELETE /api/identity/users/me

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

ðŸ”¹ Request

#### 2.5.2.6 Is Synchronous

âœ… Yes

#### 2.5.2.7 Return Message

7. HTTP 202 Accepted

#### 2.5.2.8 Has Return

âœ… Yes

#### 2.5.2.9 Is Activation

âœ… Yes

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | DELETE |
| Parameters | Headers: Authorization: Bearer <JWT>, X-Correlatio... |
| Authentication | JWT forwarded and validated. |
| Error Handling | Gateway handles upstream 5xx errors, timeouts. |
| Performance | P95 Latency < 200ms |

#### 2.5.2.11 Nested Interactions

##### 2.5.2.11.1 Self-call

###### 2.5.2.11.1.1 Source Id

identity-service-002

###### 2.5.2.11.1.2 Target Id

identity-service-002

###### 2.5.2.11.1.3 Message

3. Validate user token and initiate deletion saga

###### 2.5.2.11.1.4 Sequence Number

3

###### 2.5.2.11.1.5 Type

ðŸ”¹ Self-call

###### 2.5.2.11.1.6 Is Synchronous

âœ… Yes

###### 2.5.2.11.1.7 Has Return

âŒ No

###### 2.5.2.11.1.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | DeletionSagaOrchestrator.Begin() |
| Parameters | userId from JWT claims |
| Authentication | N/A |
| Error Handling | Throws SecurityException for invalid token. Throws... |
| Performance | N/A |

##### 2.5.2.11.2.0 Event

###### 2.5.2.11.2.1 Source Id

identity-service-002

###### 2.5.2.11.2.2 Target Id

messaging-infra-015

###### 2.5.2.11.2.3 Message

4. Publish(CriticalActionOccurred: UserDeletionInitiated)

###### 2.5.2.11.2.4 Sequence Number

4

###### 2.5.2.11.2.5 Type

ðŸ”¹ Event

###### 2.5.2.11.2.6 Is Synchronous

âŒ No

###### 2.5.2.11.2.7 Has Return

âŒ No

###### 2.5.2.11.2.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Topic: audit-events |
| Parameters | Payload: { userId, action: 'UserDeletionInitiated'... |
| Authentication | Managed Identity |
| Error Handling | Retry logic for transient broker connection issues... |
| Performance | N/A |

##### 2.5.2.11.3.0 Database Operation

###### 2.5.2.11.3.1 Source Id

identity-service-002

###### 2.5.2.11.3.2 Target Id

identity-service-002

###### 2.5.2.11.3.3 Message

5. Soft-delete user and revoke tokens

###### 2.5.2.11.3.4 Sequence Number

5

###### 2.5.2.11.3.5 Type

ðŸ”¹ Database Operation

###### 2.5.2.11.3.6 Is Synchronous

âœ… Yes

###### 2.5.2.11.3.7 Has Return

âŒ No

###### 2.5.2.11.3.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | SQL |
| Method | UPDATE Users SET Status='PendingDeletion', ...; DE... |
| Parameters | userId |
| Authentication | DB Connection String |
| Error Handling | Database transaction with rollback on failure. |
| Performance | Should complete within a transaction timeout (<30s... |

##### 2.5.2.11.4.0 Event

###### 2.5.2.11.4.1 Source Id

identity-service-002

###### 2.5.2.11.4.2 Target Id

messaging-infra-015

###### 2.5.2.11.4.3 Message

6. Publish(UserDataDeletionRequested)

###### 2.5.2.11.4.4 Sequence Number

6

###### 2.5.2.11.4.5 Type

ðŸ”¹ Event

###### 2.5.2.11.4.6 Is Synchronous

âŒ No

###### 2.5.2.11.4.7 Has Return

âŒ No

###### 2.5.2.11.4.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Topic: user-data-events |
| Parameters | Payload: { userId, correlationId } |
| Authentication | Managed Identity |
| Error Handling | Retry logic for transient broker connection issues... |
| Performance | N/A |

### 2.5.3.0.0.0 Event Delivery

#### 2.5.3.1.0.0 Source Id

messaging-infra-015

#### 2.5.3.2.0.0 Target Id

audit-service-009

#### 2.5.3.3.0.0 Message

9. Deliver(CriticalActionOccurred)

#### 2.5.3.4.0.0 Sequence Number

9

#### 2.5.3.5.0.0 Type

ðŸ”¹ Event Delivery

#### 2.5.3.6.0.0 Is Synchronous

âŒ No

#### 2.5.3.7.0.0 Has Return

âŒ No

#### 2.5.3.8.0.0 Is Activation

âœ… Yes

#### 2.5.3.9.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Subscription: audit-service-subscription |
| Parameters | N/A |
| Authentication | N/A |
| Error Handling | Consumer must be idempotent. |
| Performance | N/A |

#### 2.5.3.10.0.0 Nested Interactions

- {'sourceId': 'audit-service-009', 'targetId': 'audit-service-009', 'message': '10. Persist immutable audit log entry', 'sequenceNumber': 10, 'type': 'Database Operation', 'isSynchronous': True, 'hasReturn': False, 'technicalDetails': {'protocol': 'SQL/NoSQL', 'method': 'INSERT INTO AuditLogs...', 'parameters': 'Event Payload', 'authentication': 'DB Connection String', 'errorHandling': 'Moves to DLQ on persistent failure.', 'performance': 'Optimized for high-throughput writes.'}}

### 2.5.4.0.0.0 Event Delivery

#### 2.5.4.1.0.0 Source Id

messaging-infra-015

#### 2.5.4.2.0.0 Target Id

product-service-003

#### 2.5.4.3.0.0 Message

11. Deliver(UserDataDeletionRequested)

#### 2.5.4.4.0.0 Sequence Number

11

#### 2.5.4.5.0.0 Type

ðŸ”¹ Event Delivery

#### 2.5.4.6.0.0 Is Synchronous

âŒ No

#### 2.5.4.7.0.0 Has Return

âŒ No

#### 2.5.4.8.0.0 Is Activation

âœ… Yes

#### 2.5.4.9.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Subscription: product-service-subscription |
| Parameters | N/A |
| Authentication | N/A |
| Error Handling | Message moves to DLQ after N retries. |
| Performance | N/A |

#### 2.5.4.10.0.0 Nested Interactions

##### 2.5.4.10.1.0 Database Operation

###### 2.5.4.10.1.1 Source Id

product-service-003

###### 2.5.4.10.1.2 Target Id

product-service-003

###### 2.5.4.10.1.3 Message

12. Anonymize PII in owned data records

###### 2.5.4.10.1.4 Sequence Number

12

###### 2.5.4.10.1.5 Type

ðŸ”¹ Database Operation

###### 2.5.4.10.1.6 Is Synchronous

âœ… Yes

###### 2.5.4.10.1.7 Has Return

âŒ No

###### 2.5.4.10.1.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | SQL |
| Method | UPDATE UserProducts SET ... WHERE UserId = @userId |
| Parameters | userId from event payload |
| Authentication | DB Connection String |
| Error Handling | Transactional. Throws exception on failure, trigge... |
| Performance | Must complete within message lock duration. |

##### 2.5.4.10.2.0 Event

###### 2.5.4.10.2.1 Source Id

product-service-003

###### 2.5.4.10.2.2 Target Id

messaging-infra-015

###### 2.5.4.10.2.3 Message

13. Publish(UserDataAnonymizationCompleted)

###### 2.5.4.10.2.4 Sequence Number

13

###### 2.5.4.10.2.5 Type

ðŸ”¹ Event

###### 2.5.4.10.2.6 Is Synchronous

âŒ No

###### 2.5.4.10.2.7 Has Return

âŒ No

###### 2.5.4.10.2.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Topic: user-data-events |
| Parameters | Payload: { userId, serviceName: 'ProductService', ... |
| Authentication | Managed Identity |
| Error Handling | Retry logic for broker connection. |
| Performance | N/A |

### 2.5.5.0.0.0 Event Delivery

#### 2.5.5.1.0.0 Source Id

messaging-infra-015

#### 2.5.5.2.0.0 Target Id

service-request-service-005

#### 2.5.5.3.0.0 Message

14. Deliver(UserDataDeletionRequested)

#### 2.5.5.4.0.0 Sequence Number

14

#### 2.5.5.5.0.0 Type

ðŸ”¹ Event Delivery

#### 2.5.5.6.0.0 Is Synchronous

âŒ No

#### 2.5.5.7.0.0 Has Return

âŒ No

#### 2.5.5.8.0.0 Is Activation

âœ… Yes

#### 2.5.5.9.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Subscription: service-request-service-subscription |
| Parameters | N/A |
| Authentication | N/A |
| Error Handling | Message moves to DLQ after N retries. |
| Performance | N/A |

#### 2.5.5.10.0.0 Nested Interactions

##### 2.5.5.10.1.0 Database Operation

###### 2.5.5.10.1.1 Source Id

service-request-service-005

###### 2.5.5.10.1.2 Target Id

service-request-service-005

###### 2.5.5.10.1.3 Message

15. Anonymize PII in owned data records

###### 2.5.5.10.1.4 Sequence Number

15

###### 2.5.5.10.1.5 Type

ðŸ”¹ Database Operation

###### 2.5.5.10.1.6 Is Synchronous

âœ… Yes

###### 2.5.5.10.1.7 Has Return

âŒ No

###### 2.5.5.10.1.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | SQL |
| Method | UPDATE ServiceRequests SET RequesterAddress=... WH... |
| Parameters | userId from event payload |
| Authentication | DB Connection String |
| Error Handling | Transactional. Throws exception on failure, trigge... |
| Performance | Must complete within message lock duration. |

##### 2.5.5.10.2.0 Event

###### 2.5.5.10.2.1 Source Id

service-request-service-005

###### 2.5.5.10.2.2 Target Id

messaging-infra-015

###### 2.5.5.10.2.3 Message

16. Publish(UserDataAnonymizationCompleted)

###### 2.5.5.10.2.4 Sequence Number

16

###### 2.5.5.10.2.5 Type

ðŸ”¹ Event

###### 2.5.5.10.2.6 Is Synchronous

âŒ No

###### 2.5.5.10.2.7 Has Return

âŒ No

###### 2.5.5.10.2.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Topic: user-data-events |
| Parameters | Payload: { userId, serviceName: 'ServiceRequestSer... |
| Authentication | Managed Identity |
| Error Handling | Retry logic for broker connection. |
| Performance | N/A |

### 2.5.6.0.0.0 Event Delivery

#### 2.5.6.1.0.0 Source Id

messaging-infra-015

#### 2.5.6.2.0.0 Target Id

identity-service-002

#### 2.5.6.3.0.0 Message

17. Deliver(UserDataAnonymizationCompleted) x2

#### 2.5.6.4.0.0 Sequence Number

17

#### 2.5.6.5.0.0 Type

ðŸ”¹ Event Delivery

#### 2.5.6.6.0.0 Is Synchronous

âŒ No

#### 2.5.6.7.0.0 Has Return

âŒ No

#### 2.5.6.8.0.0 Is Activation

âŒ No

#### 2.5.6.9.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Subscription: identity-service-saga-subscription |
| Parameters | N/A |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

#### 2.5.6.10.0.0 Nested Interactions

##### 2.5.6.10.1.0 Self-call

###### 2.5.6.10.1.1 Source Id

identity-service-002

###### 2.5.6.10.1.2 Target Id

identity-service-002

###### 2.5.6.10.1.3 Message

18. Correlate events and check saga completion

###### 2.5.6.10.1.4 Sequence Number

18

###### 2.5.6.10.1.5 Type

ðŸ”¹ Self-call

###### 2.5.6.10.1.6 Is Synchronous

âœ… Yes

###### 2.5.6.10.1.7 Has Return

âŒ No

###### 2.5.6.10.1.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | DeletionSagaOrchestrator.HandleCompletionEvent() |
| Parameters | Event payload |
| Authentication | N/A |
| Error Handling | Updates saga state machine. Handles duplicate even... |
| Performance | N/A |

##### 2.5.6.10.2.0 Database Operation

###### 2.5.6.10.2.1 Source Id

identity-service-002

###### 2.5.6.10.2.2 Target Id

identity-service-002

###### 2.5.6.10.2.3 Message

19. [If Complete] Hard-delete user record

###### 2.5.6.10.2.4 Sequence Number

19

###### 2.5.6.10.2.5 Type

ðŸ”¹ Database Operation

###### 2.5.6.10.2.6 Is Synchronous

âœ… Yes

###### 2.5.6.10.2.7 Has Return

âŒ No

###### 2.5.6.10.2.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | SQL |
| Method | DELETE FROM Users WHERE UserId=@userId AND Status=... |
| Parameters | userId |
| Authentication | DB Connection String |
| Error Handling | Database transaction. Logs error on failure for ma... |
| Performance | N/A |

##### 2.5.6.10.3.0 Event

###### 2.5.6.10.3.1 Source Id

identity-service-002

###### 2.5.6.10.3.2 Target Id

messaging-infra-015

###### 2.5.6.10.3.3 Message

20. Publish(CriticalActionOccurred: UserDeletionCompleted)

###### 2.5.6.10.3.4 Sequence Number

20

###### 2.5.6.10.3.5 Type

ðŸ”¹ Event

###### 2.5.6.10.3.6 Is Synchronous

âŒ No

###### 2.5.6.10.3.7 Has Return

âŒ No

###### 2.5.6.10.3.8 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AMQP |
| Method | Topic: audit-events |
| Parameters | Payload: { userId, action: 'UserDeletionCompleted'... |
| Authentication | Managed Identity |
| Error Handling | Retry logic. |
| Performance | N/A |

## 2.6.0.0.0.0 Notes

### 2.6.1.0.0.0 Content

#### 2.6.1.1.0.0 Content

The initial response to the user is HTTP 202 Accepted, indicating the deletion process has started but is not complete. The process is fully asynchronous.

#### 2.6.1.2.0.0 Position

top

#### 2.6.1.3.0.0 Participant Id

*Not specified*

#### 2.6.1.4.0.0 Sequence Number

7

### 2.6.2.0.0.0 Content

#### 2.6.2.1.0.0 Content

All PII-modifying actions publish an event to the Audit Service, creating an immutable log for compliance verification as per REQ-AUDIT-001.

#### 2.6.2.2.0.0 Position

bottom

#### 2.6.2.3.0.0 Participant Id

audit-service-009

#### 2.6.2.4.0.0 Sequence Number

10

### 2.6.3.0.0.0 Content

#### 2.6.3.1.0.0 Content

If any participant service fails to process the deletion event, the message will be sent to a Dead-Letter Queue (DLQ). This triggers a critical alert for manual intervention.

#### 2.6.3.2.0.0 Position

bottom

#### 2.6.3.3.0.0 Participant Id

product-service-003

#### 2.6.3.4.0.0 Sequence Number

11

## 2.7.0.0.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The initial deletion request must be authenticated... |
| Performance Targets | The initial synchronous API call must respond in <... |
| Error Handling Strategy | A saga pattern is used for orchestration. Each par... |
| Testing Considerations | End-to-end tests must verify that PII is correctly... |
| Monitoring Requirements | Dashboards must monitor: 1) The rate of deletion r... |
| Deployment Considerations | This is a cross-cutting concern. Any new service t... |

